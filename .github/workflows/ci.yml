name: Build UF2 (Pico 2 W)

on:
  push:
    branches: [ main ]
    tags: [ 'v*', 'V*' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    env:
      MPY_DIR: micropython
      PORT_DIR: micropython/ports/rp2

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---- Toolchain (no custom Dockerfile) ----
      - name: Install build deps (apt)
        shell: bash
        run: |
          set -euxo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential git python3 python3-venv python3-pip \
            gcc-arm-none-eabi libnewlib-arm-none-eabi

      - name: Install latest CMake & Ninja (PyPI)  # avoids Kitware repo keys
        shell: bash
        run: |
          set -euxo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install --user cmake ninja
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          cmake --version
          ninja --version || true

      # ---- Version string (fixes the ${{ VERSION }} error) ----
      - name: Compute version string
        id: ver
        shell: bash
        run: |
          # If it's a tag build, use the tag; else short SHA
          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            V="${GITHUB_REF#refs/tags/}"
          else
            V="$(git rev-parse --short=8 HEAD)"
          fi
          echo "version=$V" >> "$GITHUB_OUTPUT"

      # ---- MicroPython checkout ----
      - name: Clone MicroPython
        shell: bash
        run: |
          set -eux
          git clone --depth 1 https://github.com/micropython/micropython.git "$MPY_DIR"
          ( cd "$MPY_DIR" && git submodule update --init --recursive )

      - name: Build mpy-cross (optional but speeds up)
        shell: bash
        run: |
          make -C "$MPY_DIR/mpy-cross" -j"$(nproc)"

      # ---- Manifest that freezes YOUR repo ----
      - name: Create frozen manifest
        shell: bash
        run: |
          cat > my_manifest.py <<'PY'
          # Pull in default rp2 modules
          include("$(PORT_DIR)/boards/manifest.py")
          # Freeze your whole repo; contains main.py at repo root
          freeze("$(GITHUB_WORKSPACE)", opt=3)
          PY
          # Also generate a tiny module with the version
          echo "__version__ = '${{ steps.ver.outputs.version }}'" > pb_version.py

      # ---- Build UF2 for Pico 2 W ----
      - name: Build (RPI_PICO2_W)
        shell: bash
        run: |
          set -eux
          # Make sure submodules step runs with the board dir created
          make -C "$PORT_DIR" BOARD=RPI_PICO2_W submodules
          make -C "$PORT_DIR" clean
          make -C "$PORT_DIR" BOARD=RPI_PICO2_W \
            FROZEN_MANIFEST="$GITHUB_WORKSPACE/my_manifest.py" \
            USER_C_MODULES= \
            -j"$(nproc)"

      # ---- Package artifact with your exact name ----
      - name: Collect artifact
        id: pkg
        shell: bash
        run: |
          set -eux
          OUT="picobridge_${{ steps.ver.outputs.version }}.uf2"
          cp "$PORT_DIR/build-RPI_PICO2_W/firmware.uf2" "$OUT"
          echo "outfile=$OUT" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.pkg.outputs.outfile }}
          path: ${{ steps.pkg.outputs.outfile }}
          if-no-files-found: error
