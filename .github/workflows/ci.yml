name: Build UF2 (Pico 2 W)

on:
  push:
    branches: [ main ]
    tags: [ 'v*', 'V*', 'pico-*' ]   # optional
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    env:
      MPY_DIR: micropython
      PORT_DIR: micropython/ports/rp2

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install deps inside the self-hosted runner container (no custom image)
      - name: Install toolchain & newer CMake
        run: |
          set -euxo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            gpg wget ca-certificates software-properties-common \
            build-essential git python3 python3-venv \
            gcc-arm-none-eabi libnewlib-arm-none-eabi
          
          # Remove old cmake if present
          apt-get -y purge cmake || true
          # Add Kitware repo for newer cmake
          wget -O /usr/share/keyrings/kitware-archive-keyring.gpg https://apt.kitware.com/keys/kitware-archive-latest.asc
          echo "deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(. /etc/os-release; echo $VERSION_CODENAME) main" > /etc/apt/sources.list.d/kitware.list
          apt-get update
          apt-get install -y --no-install-recommends cmake
          cmake --version
          arm-none-eabi-gcc --version

      # Compute VERSION: tag name if building a tag, else short SHA
      - name: Compute VERSION
        run: |
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            echo "VERSION=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          else
            echo "VERSION=${GITHUB_SHA::7}" >> "$GITHUB_ENV"
          fi
          echo "Using VERSION=${VERSION}"

      - name: Clone MicroPython
        run: |
          git clone --depth 1 https://github.com/micropython/micropython.git "$MPY_DIR"
          cd "$MPY_DIR"
          git submodule update --init --recursive

      - name: Build mpy-cross
        run: make -C "$MPY_DIR/mpy-cross" -j"$(nproc)"

      # Create a manifest that freezes your repo. Note the escaped \$ to keep
      # $(PORT_DIR) and $(GITHUB_WORKSPACE) literal for the MicroPython build,
      # while letting ${VERSION} expand here.
      - name: Create frozen manifest
        run: |
          cat > my_manifest.py <<EOF
          include("\$(PORT_DIR)/boards/manifest.py")
          freeze("\$(GITHUB_WORKSPACE)", opt=3)
          module("pb_version.py", "__version__ = '${VERSION}'\n")
          EOF
          echo "Manifest:"
          sed -n '1,200p' my_manifest.py

      - name: Build UF2 (RPI_PICO2_W)
        working-directory: ${{ env.PORT_DIR }}
        run: |
          make -C "$PORT_DIR" submodules
          make -C "$PORT_DIR" clean
          make -C "$PORT_DIR" BOARD=RPI_PICO2_W FROZEN_MANIFEST=$GITHUB_WORKSPACE/my_manifest.py -j"$(nproc)"

      - name: Collect artifact (picobridge_${{ env.VERSION }}.uf2)
        run: |
          mkdir -p out
          cp "$PORT_DIR/build-RPI_PICO2_W/firmware.uf2" "out/picobridge_${VERSION}.uf2"
          ls -l out

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: picobridge_${{ env.VERSION }}
          path: out/picobridge_${{ env.VERSION }}.uf2
          if-no-files-found: error
